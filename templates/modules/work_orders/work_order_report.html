{% extends "base.html" %}

{% block title %}Work Order Report - Plant Maintenance{% endblock %}

{% block content %}
<div class="module-container">
    <div class="module-header">
        <a href="{{ url_for('work_orders.index') }}" class="btn btn-back">
            &#8592; Back to Work Orders
        </a>
    </div>

    <div class="list-container">
        <div class="list-header">
            <span style="font-size: 2.5rem;">&#128203;</span>
            <h1>Work Order Report</h1>
            <p>{{ work_orders|length }} work order(s) in system</p>
        </div>

        {% if work_orders %}
        <div class="inventory-legend">
            <span class="legend-item">
                <span class="legend-color legend-emergency"></span> Emergency
            </span>
            <span class="legend-item">
                <span class="legend-color legend-high"></span> High Priority
            </span>
            <span class="legend-item">
                <span class="legend-color legend-on-hold"></span> On Hold
            </span>
        </div>

        <div class="search-filter-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search work orders..." class="search-input">
            </div>
            <div class="filter-options">
                <label class="filter-label">Status:</label>
                <div class="multi-select-dropdown" id="statusFilterContainer">
                    <button type="button" class="multi-select-btn" id="statusFilterBtn">
                        All Statuses <span class="dropdown-arrow">&#9662;</span>
                    </button>
                    <div class="multi-select-menu" id="statusFilterMenu">
                        <label class="multi-select-item">
                            <input type="checkbox" value="Open" checked> Open
                        </label>
                        <label class="multi-select-item">
                            <input type="checkbox" value="In Progress" checked> In Progress
                        </label>
                        <label class="multi-select-item">
                            <input type="checkbox" value="On Hold" checked> On Hold
                        </label>
                        <label class="multi-select-item">
                            <input type="checkbox" value="Completed"> Completed
                        </label>
                        <label class="multi-select-item">
                            <input type="checkbox" value="Cancelled"> Cancelled
                        </label>
                        <div class="multi-select-actions">
                            <button type="button" class="btn-select-all" id="selectAllStatus">Select All</button>
                            <button type="button" class="btn-select-none" id="selectNoneStatus">Clear All</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="filter-options">
                <label class="filter-label">Priority:</label>
                <select id="priorityFilter" class="filter-select">
                    <option value="all">All Priorities</option>
                    <option value="Emergency">Emergency</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div class="search-results">
                <span id="resultCount">{{ work_orders|length }}</span> of {{ work_orders|length }} shown
            </div>
        </div>

        <div class="table-responsive">
            <table class="data-table sortable-table work-order-table" id="workOrderTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="0" data-type="string">WO Number <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="1" data-type="string">Title <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="2" data-type="string">Equipment <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="3" data-type="string">Location <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="4" data-type="string">Priority <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="5" data-type="string">Status <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="6" data-type="string">Assigned To <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="7" data-type="string">Due Date <span class="sort-icon">&#8597;</span></th>
                        <th class="sortable" data-column="8" data-type="string">Created By <span class="sort-icon">&#8597;</span></th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for wo in work_orders %}
                    <tr class="{% if wo.priority == 'Emergency' %}row-emergency{% elif wo.priority == 'High' %}row-high-priority{% elif wo.status == 'On Hold' %}row-on-hold{% endif %}" data-status="{{ wo.status }}" data-priority="{{ wo.priority }}">
                        <td>{{ wo.work_order_number }}</td>
                        <td>{{ wo.title }}</td>
                        <td>{{ wo.equipment_tag or '-' }}</td>
                        <td>{{ wo.location_code or '-' }}</td>
                        <td>
                            <span class="priority-badge priority-{{ wo.priority|lower }}">{{ wo.priority }}</span>
                        </td>
                        <td>
                            <span class="status-badge status-wo-{{ wo.status|lower|replace(' ', '-') }}">{{ wo.status }}</span>
                        </td>
                        <td>{{ wo.assigned_to_name or '-' }}</td>
                        <td>{{ wo.due_date or '-' }}</td>
                        <td>{{ wo.created_by_name or '-' }}</td>
                        <td>
                            <a href="{{ url_for('work_orders.view_detail', wo_id=wo.id) }}" class="btn btn-small">
                                View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <span style="font-size: 3rem;">&#128203;</span>
            <p>No work orders found.</p>
            <a href="{{ url_for('work_orders.add') }}" class="btn btn-primary">Create First Work Order</a>
        </div>
        {% endif %}
    </div>
</div>

<style>
.multi-select-dropdown {
    position: relative;
    display: inline-block;
}
.multi-select-btn {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    min-width: 150px;
    text-align: left;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.multi-select-btn:hover {
    border-color: #4a90d9;
}
.dropdown-arrow {
    margin-left: 0.5rem;
}
.multi-select-menu {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 1000;
    min-width: 180px;
    max-height: 250px;
    overflow-y: auto;
}
.multi-select-menu.show {
    display: block;
}
.multi-select-item {
    display: block;
    padding: 0.5rem 1rem;
    cursor: pointer;
    white-space: nowrap;
}
.multi-select-item:hover {
    background-color: #f0f0f0;
}
.multi-select-item input {
    margin-right: 0.5rem;
}
.multi-select-actions {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem;
    border-top: 1px solid #ddd;
    background: #f9f9f9;
}
.btn-select-all, .btn-select-none {
    flex: 1;
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
    border: 1px solid #ddd;
    border-radius: 3px;
    cursor: pointer;
    background: white;
}
.btn-select-all:hover, .btn-select-none:hover {
    background: #e0e0e0;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const statusFilterBtn = document.getElementById('statusFilterBtn');
    const statusFilterMenu = document.getElementById('statusFilterMenu');
    const statusCheckboxes = statusFilterMenu.querySelectorAll('input[type="checkbox"]');
    const selectAllStatus = document.getElementById('selectAllStatus');
    const selectNoneStatus = document.getElementById('selectNoneStatus');
    const priorityFilter = document.getElementById('priorityFilter');
    const table = document.getElementById('workOrderTable');
    const resultCount = document.getElementById('resultCount');

    if (!searchInput || !table) return;

    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    let currentSort = { column: null, direction: 'asc' };

    // Toggle dropdown menu
    statusFilterBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        statusFilterMenu.classList.toggle('show');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!statusFilterMenu.contains(e.target) && e.target !== statusFilterBtn) {
            statusFilterMenu.classList.remove('show');
        }
    });

    // Select All button
    selectAllStatus.addEventListener('click', function() {
        statusCheckboxes.forEach(cb => cb.checked = true);
        updateStatusButtonText();
        filterTable();
    });

    // Clear All button
    selectNoneStatus.addEventListener('click', function() {
        statusCheckboxes.forEach(cb => cb.checked = false);
        updateStatusButtonText();
        filterTable();
    });

    // Update button text based on selections
    function updateStatusButtonText() {
        const checked = Array.from(statusCheckboxes).filter(cb => cb.checked);
        if (checked.length === 0) {
            statusFilterBtn.innerHTML = 'No Status <span class="dropdown-arrow">&#9662;</span>';
        } else if (checked.length === statusCheckboxes.length) {
            statusFilterBtn.innerHTML = 'All Statuses <span class="dropdown-arrow">&#9662;</span>';
        } else if (checked.length === 1) {
            statusFilterBtn.innerHTML = checked[0].value + ' <span class="dropdown-arrow">&#9662;</span>';
        } else {
            statusFilterBtn.innerHTML = checked.length + ' Selected <span class="dropdown-arrow">&#9662;</span>';
        }
    }

    // Handle checkbox changes
    statusCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            updateStatusButtonText();
            filterTable();
        });
    });

    function getSelectedStatuses() {
        return Array.from(statusCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value);
    }

    function filterTable() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        const selectedStatuses = getSelectedStatuses();
        const priorityFilterValue = priorityFilter.value;
        const rows = tbody.querySelectorAll('tr');
        let visibleCount = 0;

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowStatus = row.dataset.status;
            const rowPriority = row.dataset.priority;
            let matchSearch = false;
            let matchStatus = false;
            let matchPriority = false;

            // Check status filter (multiple selection)
            matchStatus = selectedStatuses.length === 0 || selectedStatuses.includes(rowStatus);

            // Check priority filter
            matchPriority = (priorityFilterValue === 'all' || rowPriority === priorityFilterValue);

            // Check search term
            if (searchTerm === '') {
                matchSearch = true;
            } else {
                for (let i = 0; i < cells.length - 1; i++) {
                    if (cells[i].textContent.toLowerCase().includes(searchTerm)) {
                        matchSearch = true;
                        break;
                    }
                }
            }

            const show = matchSearch && matchStatus && matchPriority;
            row.style.display = show ? '' : 'none';
            if (show) visibleCount++;
        });

        resultCount.textContent = visibleCount;
    }

    function sortTable(columnIndex, dataType) {
        const rows = Array.from(tbody.querySelectorAll('tr'));

        if (currentSort.column === columnIndex) {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
        } else {
            currentSort.column = columnIndex;
            currentSort.direction = 'asc';
        }

        headers.forEach(header => {
            const icon = header.querySelector('.sort-icon');
            if (parseInt(header.dataset.column) === columnIndex) {
                icon.innerHTML = currentSort.direction === 'asc' ? '&#8593;' : '&#8595;';
                header.classList.add('sorted');
            } else {
                icon.innerHTML = '&#8597;';
                header.classList.remove('sorted');
            }
        });

        rows.sort((a, b) => {
            let aVal = a.querySelectorAll('td')[columnIndex].textContent.trim();
            let bVal = b.querySelectorAll('td')[columnIndex].textContent.trim();

            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();

            if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
            if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
            return 0;
        });

        rows.forEach(row => tbody.appendChild(row));
    }

    searchInput.addEventListener('input', filterTable);
    priorityFilter.addEventListener('change', filterTable);

    headers.forEach(header => {
        header.addEventListener('click', function() {
            const column = parseInt(this.dataset.column);
            const type = this.dataset.type;
            sortTable(column, type);
        });
    });

    // Apply initial filter on page load
    updateStatusButtonText();
    filterTable();
});
</script>
{% endblock %}
